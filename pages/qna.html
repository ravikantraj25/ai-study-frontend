<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Ask Questions â€” AI Study</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../styles.css">

<style>
  .page-wrapper { max-width:920px; margin:36px auto; padding: 0 20px; }
  
  /* Input Card */
  .card { 
    padding:24px; 
    border-radius:16px; 
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
    box-shadow:0 10px 30px rgba(2,6,23,0.55); 
    border: 1px solid rgba(255,255,255,0.05);
  }

  textarea { 
    width:100%; 
    padding:16px; 
    border-radius:12px; 
    background:rgba(0,0,0,0.2); 
    border:1px solid rgba(255,255,255,0.1); 
    color:inherit; 
    resize:vertical; 
    font-size:1rem;
    transition: 0.2s;
    font-family: inherit;
  }
  textarea:focus { border-color: #7f5af0; outline: none; background:rgba(0,0,0,0.3); }

  /* Question Row */
  .input-row { display:flex; gap:12px; margin-top:16px; align-items:flex-start; flex-wrap: wrap; }
  
  input[type="text"] {
    flex-grow: 1;
    min-width: 250px;
    padding: 14px;
    border-radius: 12px;
    background: rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    font-size: 1rem;
    transition: 0.2s;
  }
  input[type="text"]:focus { border-color: #7f5af0; outline: none; background:rgba(0,0,0,0.3); }

  /* Buttons */
  .btn-primary { 
    padding:14px 24px; 
    border-radius:12px; 
    border:none; 
    background:linear-gradient(90deg,#7f5af0,#5eead4); 
    color:#021; 
    font-weight:700; 
    cursor:pointer;
    white-space: nowrap;
    transition: transform 0.1s;
  }
  .btn-primary:active { transform: scale(0.97); }

  /* ----------------------- */
  /* RESULT STYLES          */
  /* ----------------------- */
  
  .result-container { margin-top: 30px; animation: fadeIn 0.4s ease; }

  /* Answer Box */
  .answer-card {
    background: rgba(255,255,255,0.02);
    border-left: 4px solid #5eead4; /* Teal Accent */
    border-radius: 0 12px 12px 0;
    padding: 24px;
    margin-bottom: 20px;
  }
  .answer-label { font-size: 0.85rem; color: #5eead4; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 700; }
  .answer-text { font-size: 1.1rem; line-height: 1.6; color: #fff; }

  /* Evidence Box */
  .evidence-box {
    background: rgba(127, 90, 240, 0.1);
    padding: 16px;
    border-radius: 12px;
    border: 1px dashed rgba(127, 90, 240, 0.3);
    margin-bottom: 20px;
  }
  .evidence-label { font-size: 0.8rem; color: #a5b4fc; margin-bottom: 4px; display:flex; align-items:center; gap:6px; font-weight: 700; }
  .evidence-text { font-style: italic; color: rgba(255,255,255,0.8); font-size: 0.95rem; line-height: 1.5; }

  /* Follow Ups */
  .follow-label { font-size: 0.9rem; margin-bottom: 12px; color: rgba(255,255,255,0.6); }
  .chips-container { display: flex; flex-wrap: wrap; gap: 10px; }
  .chip {
    padding: 10px 18px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 24px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: 0.2s;
    color: #e2e8f0;
  }
  .chip:hover { background: rgba(127, 90, 240, 0.2); border-color: #7f5af0; color: #fff; transform: translateY(-2px); }

  .hidden { display:none }
  .loader { width:20px; height:20px; border-radius:50%; border:3px solid rgba(255,255,255,0.1); border-top-color:#5eead4; animation:spin 900ms linear infinite; display:inline-block; vertical-align: middle; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
  @keyframes spin { to{transform:rotate(360deg)} }

</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">AI Study</div>
  <a href="../index.html">Home</a>
  <a href="flashcards.html">Flashcards</a>
  <a href="summarize.html">Summarize PDF</a>
  <a href="make-notes.html">Make Notes</a>
  <a href="mcq.html">Make MCQ</a>
  <a href="explain.html">Explain</a>
  <a href="qna.html" class="active">QnA</a>
  <a href="notes.html">Notes History</a>
  <div class="spacer"></div>
  <a href="profile.html">Update Profile</a>
  <a href="delete-account.html">Delete Account</a>
</aside>

<main class="content-with-sidebar">
  <div class="page-wrapper container">
    <h1 class="h-gradient">Ask Questions</h1>
    <p class="center mt-8">Ask specific questions about your text and get instant, evidence-backed answers.</p>

    <div class="card mt-18">
      
      <div style="margin-bottom:8px; color:rgba(255,255,255,0.5); font-size:0.85rem; font-weight:600; text-transform: uppercase;">1. Paste Content (Context)</div>
      <textarea id="qna-context" rows="5" placeholder="Paste the chapter, article, or notes you want to ask about..."></textarea>
      
      <div style="margin-top:24px; margin-bottom:8px; color:rgba(255,255,255,0.5); font-size:0.85rem; font-weight:600; text-transform: uppercase;">2. Your Question</div>
      <div class="input-row">
        <input type="text" id="qna-question" placeholder="e.g. What are the key limitations mentioned in this text?">
        <button id="qna-btn" class="btn-primary">Ask AI</button>
      </div>
       
      <div style="text-align:right; margin-top:10px; height:20px;">
        <span id="loader" class="loader hidden"></span>
      </div>
    </div>

    <div id="qna-result"></div>
  </div>
</main>

<script src="../config.js"></script>
<script>
(() => {
  const API = window.API_BASE || "";
  const tokenKey = "ai_study_token";
  
  const contextEl = document.getElementById("qna-context");
  const questionEl = document.getElementById("qna-question");
  const btn = document.getElementById("qna-btn");
  const loader = document.getElementById("loader");
  const out = document.getElementById("qna-result");

  const esc = t => String(t||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  
  // Helper to make **bold** text render as actual HTML bold
  const parseBold = t => esc(t).replace(/\*\*(.*?)\*\*/g, '<strong style="color:#5eead4">$1</strong>');

  // --- API Call Function ---
  async function askAI(question) {
    const text = contextEl.value.trim();
    if(!text) { alert("Please paste some context text first."); return; }
    if(!question) { alert("Please ask a question."); return; }

    out.innerHTML = "";
    loader.classList.remove("hidden");
    btn.disabled = true;

    try {
      const headers = { "Content-Type": "application/json" };
      const token = localStorage.getItem(tokenKey);
      if(token) headers["Authorization"] = "Bearer " + token;

      // ðŸ‘‡ FIXED: Added /api/study prefix
      const resp = await fetch(`${API}/api/study/qna`, { 
        method: "POST",
        headers,
        body: JSON.stringify({ text: text, question: question }) 
      });

      const data = await resp.json();
      
      // Handle the wrapper if backend sends { "answer_data": { ... } }
      const result = data.answer_data || data;

      renderResult(result);

    } catch(err) {
      out.innerHTML = `<p style="color:#ff4d6d; text-align:center; margin-top:20px;">Error: ${esc(err.message)}</p>`;
    } finally {
      loader.classList.add("hidden");
      btn.disabled = false;
    }
  }

  // --- Render Function ---
  function renderResult(data) {
    // Case: Answer found success=false (e.g. not in text)
    if(data.success === false && data.answer) {
       out.innerHTML = `
         <div class="result-container">
           <div class="answer-card" style="border-left-color:#ff4d6d">
             <div class="answer-label" style="color:#ff4d6d">Not Found</div>
             <div class="answer-text">${esc(data.answer)}</div>
           </div>
         </div>`;
       return;
    }

    // Case: Success
    let html = `
      <div class="result-container">
        
        <div class="answer-card">
          <div class="answer-label">AI Answer</div>
          <div class="answer-text">${parseBold(data.answer)}</div>
        </div>

        ${ data.evidence ? `
        <div class="evidence-box">
          <div class="evidence-label">ðŸ“– Source Evidence</div>
          <div class="evidence-text">"...${esc(data.evidence)}..."</div>
        </div>` : '' }

        ${ data.follow_ups && data.follow_ups.length > 0 ? `
        <div class="follow-label">Suggested Follow-ups:</div>
        <div class="chips-container">
          ${data.follow_ups.map(q => {
             // Escape single quotes correctly for the inline function call
             const safeQ = q.replace(/'/g, "\\'");
             return `<div class="chip" onclick="setInputAndAsk('${safeQ}')">${esc(q)}</div>`;
          }).join('')}
        </div>` : '' }

      </div>
    `;

    out.innerHTML = html;
  }

  // --- Event Listeners ---
  btn.addEventListener("click", () => askAI(questionEl.value.trim()));
  
  // Allow Enter key in question input
  questionEl.addEventListener("keypress", (e) => {
    if(e.key === "Enter") askAI(questionEl.value.trim());
  });

  // Global helper for the Chips to work
  window.setInputAndAsk = (q) => {
    questionEl.value = q;
    askAI(q);
  };

})();
</script>

</body>
</html>