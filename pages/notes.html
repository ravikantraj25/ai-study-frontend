<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>History â€” AI Study</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../styles.css">

<style>
  .page-wrapper { max-width:960px; margin:36px auto; }
  
  .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  
  /* History Card */
  .h-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
  }
  .h-card:hover { transform: translateY(-4px); background: rgba(255,255,255,0.06); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
  
  .h-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
  .h-icon { font-size: 1.5rem; background: rgba(255,255,255,0.1); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
  .h-type { font-size: 0.7rem; text-transform: uppercase; color: #a5b4fc; font-weight: 700; letter-spacing: 1px; padding-top: 5px; }
  
  .h-title { font-size: 1.1rem; font-weight: 700; color: #fff; margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .h-preview { font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-bottom: 20px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }
  
  .h-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); }
  .h-date { font-size: 0.75rem; color: rgba(255,255,255,0.4); }
  
  .btn-view {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid rgba(127, 90, 240, 0.3);
    background: rgba(127, 90, 240, 0.1);
    color: #a5b4fc;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-view:hover { background: #7f5af0; color: #fff; border-color: #7f5af0; }

  /* Modal Styles */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
    z-index: 100; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease;
  }
  .modal-overlay.active { display: flex; opacity: 1; }
  
  .modal-content {
    background: #16161a;
    width: 90%; max-width: 800px; max-height: 85vh;
    border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
    overflow-y: auto; padding: 40px; position: relative;
    box-shadow: 0 25px 50px rgba(0,0,0,0.6);
    transform: scale(0.95); transition: transform 0.3s ease;
  }
  .modal-overlay.active .modal-content { transform: scale(1); }

  .close-btn { position: absolute; top: 20px; right: 25px; font-size: 28px; cursor: pointer; color: rgba(255,255,255,0.5); transition: 0.2s; }
  .close-btn:hover { color: #fff; }

  /* Modal Internal Styles */
  .modal-title { font-size: 2rem; font-weight: 800; background: linear-gradient(90deg, #fff, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
  .section-head { color: #5eead4; font-size: 1.3rem; font-weight: 700; margin-bottom: 10px; margin-top: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
  .section-text { color: #e2e8f0; line-height: 1.7; font-size: 1.05rem; }
  ul { padding-left: 20px; color: rgba(255,255,255,0.8); line-height: 1.6; }
  li { margin-bottom: 8px; }

</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">AI Study</div>
  <a href="../index.html">Home</a>
  <a href="summarize.html">Summarize PDF</a>
  <a href="make-notes.html">Make Notes</a>
  <a href="mcq.html">Make MCQ</a>
  <a href="explain.html">Explain</a>
  <a href="qna.html">QnA</a>
  <a href="notes.html" class="active">History</a>
  <div class="spacer"></div>
  <a href="profile.html">Update Profile</a>
  <a href="delete-account.html">Delete Account</a>
</aside>

<main class="content-with-sidebar">
  <div class="page-wrapper container">
    <h1 class="h-gradient">Your History</h1>
    <p class="center mt-8">Access your past summaries, notes, and QnA sessions.</p>

    <div id="history-list" class="history-grid mt-18"></div>
    <div id="loader" class="loader" style="margin: 20px auto; display:block;"></div>
  </div>
</main>

<div id="view-modal" class="modal-overlay">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

<script src="../config.js"></script>
<script>
(() => {
  const API = window.API_BASE || "";
  const tokenKey = "ai_study_token";
  const listEl = document.getElementById("history-list");
  const loader = document.getElementById("loader");
  const modal = document.getElementById("view-modal");
  const modalBody = document.getElementById("modal-body");

  // Format Helper
  const esc = t => String(t||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  const parseBold = t => esc(t).replace(/\*\*(.*?)\*\*/g, '<strong style="color:#5eead4">$1</strong>');

  // --- 1. FETCH HISTORY ---
  async function loadHistory() {
    try {
      const headers = { "Content-Type": "application/json" };
      const token = localStorage.getItem(tokenKey);
      if(!token) { window.location.href = "login.html"; return; }
      
      headers["Authorization"] = "Bearer " + token;

      const resp = await fetch(API + "/history", { headers });
      if(resp.status === 401) { window.location.href = "login.html"; return; }

      const data = await resp.json();
      renderList(data.history || []);

    } catch(err) {
      listEl.innerHTML = `<p style="color:#ff4d6d; text-align:center; grid-column:1/-1;">Error loading history: ${err.message}</p>`;
    } finally {
      loader.style.display = "none";
    }
  }

  // --- 2. RENDER CARD LIST ---
  function renderList(items) {
    if(!items || items.length === 0) {
      listEl.innerHTML = "<p class='center' style='grid-column:1/-1; color:rgba(255,255,255,0.5)'>No history found. Start using tools to generate content!</p>";
      return;
    }

    listEl.innerHTML = items.map((item, index) => {
      // Determine Visuals based on Item Type
      let icon = "ðŸ“„";
      let label = "Document";
      
      // Determine Title & Preview safely (No Slicing Errors!)
      let displayTitle = "Untitled";
      let displayPreview = "Click to view content...";
      
      const res = item.result || {};
      const inp = item.input || {};

      // LOGIC: Try to get a smart title from the Result JSON, fallback to Input Filename/Text
      
      // A. SUMMARIES
      if (item.type === 'pdf_summarize' || item.type === 'summarize') {
         icon = "ðŸ“‘"; label = "Summary";
         const sum = res.summary || res; // Handle wrapper
         displayTitle = sum.title || inp.filename || "PDF Summary";
         displayPreview = sum.overview || "Generated summary of document.";
      }
      // B. NOTES
      else if (item.type === 'make_notes') {
         icon = "ðŸ“"; label = "Notes";
         const note = res.notes_data || res;
         displayTitle = note.title || "Study Notes";
         displayPreview = note.summary || "Structured bullet points from text.";
      }
      // C. QnA
      else if (item.type === 'qna') {
         icon = "ðŸ’¬"; label = "Q & A";
         displayTitle = inp.question || "Question";
         const ans = res.answer_data || res;
         displayPreview = ans.answer || "AI Answer response.";
      }
      // D. MCQ
      else if (item.type === 'make_mcq') {
         icon = "âœ…"; label = "Quiz";
         displayTitle = "MCQ Practice Set";
         displayPreview = "Multiple choice questions generated from text.";
      }
      // E. EXPLAIN
      else if (item.type === 'explain') {
         icon = "ðŸ§ "; label = "Explanation";
         displayTitle = inp.topic || "Topic Explanation";
         const exp = res.explanation || res;
         // Try to grab first paragraph if array
         if(Array.isArray(exp) && exp[0]) displayPreview = exp[0].paragraph || "Deep dive explanation.";
      }

      // Safe truncate for display
      if(displayTitle.length > 60) displayTitle = displayTitle.substring(0, 60) + "...";
      if(typeof displayPreview === 'string' && displayPreview.length > 100) displayPreview = displayPreview.substring(0, 100) + "...";

      return `
        <div class="h-card">
          <div class="h-header">
             <div class="h-icon">${icon}</div>
             <div class="h-type">${label}</div>
          </div>
          <div class="h-title">${esc(displayTitle)}</div>
          <div class="h-preview">${esc(displayPreview)}</div>
          
          <div class="h-footer">
             <div class="h-date">${new Date(item.created_at).toLocaleDateString()}</div>
             <button class="btn-view" onclick="openItem(${index})">Open</button>
          </div>
        </div>
      `;
    }).join('');
    
    window.historyItems = items;
  }

  // --- 3. OPEN MODAL & RENDER CONTENT ---
  window.openItem = (index) => {
    const item = window.historyItems[index];
    const data = item.result;
    const inp = item.input || {};
    
    let html = "";

    // -- A. Summary Handler --
    if(item.type === 'pdf_summarize' || item.type === 'summarize') {
       const sum = data.summary || data; 
       html += `<div class="modal-title">${esc(sum.title || inp.filename || "Summary")}</div>`;
       html += `<p style="opacity:0.8; margin-bottom:20px; font-size:1.1rem;">${esc(sum.overview || "")}</p>`;
       
       if(sum.sections) {
         sum.sections.forEach(sec => {
           html += `<div class="section-head">${esc(sec.heading)}</div>`;
           html += `<p class="section-text">${esc(sec.content)}</p>`;
           if(sec.bullets) {
             html += `<ul>${sec.bullets.map(b=>`<li>${esc(b)}</li>`).join('')}</ul>`;
           }
         });
       }
    } 
    // -- B. Notes Handler --
    else if (item.type === 'make_notes') {
       const note = data.notes_data || data.notes || data;
       html += `<div class="modal-title">${esc(note.title || "Study Notes")}</div>`;
       html += `<p style="opacity:0.8; font-style:italic; margin-bottom:20px;">${esc(note.summary || "")}</p>`;
       
       if(note.sections) {
         note.sections.forEach(sec => {
           html += `<div class="section-head">${esc(sec.heading)}</div>`;
           html += `<ul>${sec.points.map(p=>`<li>${parseBold(p)}</li>`).join('')}</ul>`;
         });
       } else if (typeof note === 'string') {
         html += `<pre style="white-space:pre-wrap; color:#ddd;">${esc(note)}</pre>`;
       }
    }
    // -- C. QnA Handler --
    else if (item.type === 'qna') {
       const qna = data.answer_data || data;
       html += `<div class="modal-title">QnA Session</div>`;
       
       html += `<div class="section-head">Question</div>`;
       html += `<p class="section-text" style="font-weight:bold;">${esc(inp.question)}</p>`;

       html += `<div class="section-head">Answer</div>`;
       html += `<p class="section-text">${parseBold(qna.answer)}</p>`;
       
       if(qna.evidence) {
         html += `<div class="section-head">Evidence</div>`;
         html += `<p style="font-style:italic; color:#a5b4fc;">"${esc(qna.evidence)}"</p>`;
       }
    }
    // -- D. MCQ Handler --
    else if (item.type === 'make_mcq') {
       const mcqs = data.mcqs_data || data; // Assuming backend sends structured list
       // If backend sends text block
       if (typeof mcqs === 'string') {
          html += `<div class="modal-title">Generated MCQs</div>`;
          html += `<pre style="white-space:pre-wrap; color:#ddd;">${esc(mcqs)}</pre>`;
       } else {
          // If backend sends array
          html += `<div class="modal-title">Generated MCQs</div>`;
          // (Add parsing logic here if you stored structured MCQs, otherwise fall back to raw dump)
          html += `<pre>${JSON.stringify(mcqs, null, 2)}</pre>`;
       }
    }
    // -- E. Explain Handler --
    else if (item.type === 'explain') {
       const exp = data.explanation || data;
       html += `<div class="modal-title">${esc(inp.topic || "Explanation")}</div>`;
       
       if(Array.isArray(exp)) {
         exp.forEach(sec => {
            html += `<div class="section-head">${esc(sec.title)}</div>`;
            html += `<p class="section-text">${esc(sec.paragraph)}</p>`;
            if(sec.bullets) html += `<ul>${sec.bullets.map(b=>`<li>${esc(b)}</li>`).join('')}</ul>`;
         });
       } else {
         html += `<pre>${esc(JSON.stringify(exp, null, 2))}</pre>`;
       }
    }
    // -- Fallback --
    else {
      html += `<div class="modal-title">Raw Data</div>`;
      html += `<pre>${esc(JSON.stringify(data, null, 2))}</pre>`;
    }

    modalBody.innerHTML = html;
    modal.classList.add("active");
  };

  window.closeModal = () => {
    modal.classList.remove("active");
  };

  loadHistory();
})();
</script>
</body>
</html>