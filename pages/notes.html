<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<title>History ‚Äî AI Study</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../styles.css">

<style>
  /* =========================================
     1. THEME VARIABLES (Orange/Pink Match)
     ========================================= */
  :root {
    --font-main: 'Inter', sans-serif;
    --transition-speed: 0.3s;
    
    /* DARK MODE DEFAULTS */
    --bg-body: #0f172a;      
    --bg-sidebar: #1e293b;   
    --bg-card: rgba(30, 41, 59, 0.7);
    --border-color: rgba(255, 255, 255, 0.1);
    
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    
    /* ORANGE & PINK GRADIENT */
    --accent-primary: #f97316; /* Orange */
    --accent-secondary: #db2777; /* Pink */
    --accent-gradient: linear-gradient(135deg, #f97316 0%, #db2777 100%);
    
    --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --nav-hover: rgba(255, 255, 255, 0.05);
  }

  /* LIGHT MODE OVERRIDES */
  [data-theme="light"] {
    --bg-body: #f8fafc;
    --bg-sidebar: #ffffff;
    --bg-card: #ffffff;
    --border-color: #e2e8f0;

    --text-main: #0f172a;
    --text-muted: #64748b;

    --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --nav-hover: #f1f5f9;
  }

  /* =========================================
     2. GLOBAL RESET
     ========================================= */
  * { box-sizing: border-box; }
  
  body {
    margin: 0;
    background-color: var(--bg-body);
    color: var(--text-main);
    font-family: var(--font-main);
    transition: background-color var(--transition-speed), color var(--transition-speed);
  }

  a { text-decoration: none; color: inherit; }

  /* =========================================
     3. SIDEBAR (Fixed Layout)
     ========================================= */
  .sidebar {
    width: 260px;
    height: 100vh;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border-color);
    position: fixed;
    top: 0; left: 0;
    padding: 24px;
    display: flex;
    flex-direction: column;
    z-index: 1000;
  }

  .brand {
    font-size: 1.5rem;
    font-weight: 800;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 30px;
    padding-left: 12px;
  }

  .nav-links {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .nav-links a {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-radius: 12px;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.2s ease;
  }
  
  .nav-links a:hover {
    background: var(--nav-hover);
    color: var(--text-main);
    transform: translateX(4px);
  }

  .nav-links a.active {
    background: rgba(249, 115, 22, 0.1);
    color: var(--accent-primary);
    font-weight: 600;
  }

  .nav-icon { margin-right: 12px; font-size: 1.1rem; }
  .spacer { flex: 1; }

  /* =========================================
     4. MAIN CONTENT
     ========================================= */
  .main-content {
    margin-left: 260px;
    padding: 40px 60px;
    min-height: 100vh;
    max-width: 1400px;
  }

  .top-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 20px;
  }
  
  .theme-toggle {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    width: 44px; height: 44px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
  }
  .theme-toggle:hover { transform: scale(1.05); }

  .page-header { text-align: center; margin-bottom: 40px; animation: fadeIn 0.5s ease; }
  
  .h-gradient {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -1px;
    line-height: 1.2;
  }
  
  .sub-text { color: var(--text-muted); font-size: 1.1rem; margin-top: 10px; }

  /* =========================================
     5. HISTORY GRID & CARDS
     ========================================= */
  .history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
    animation: fadeIn 0.6s ease-out;
  }

  .h-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 24px;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    height: 240px;
    box-shadow: var(--shadow-card);
  }
  .h-card:hover {
    transform: translateY(-5px);
    border-color: var(--accent-primary);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  }

  .h-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  
  .h-icon-box {
    width: 44px; height: 44px;
    background: var(--nav-hover);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  .h-type {
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--accent-primary);
    background: rgba(249, 115, 22, 0.1);
    padding: 4px 10px;
    border-radius: 20px;
  }

  .h-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 8px;
    line-height: 1.4;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }

  .h-preview {
    font-size: 0.95rem;
    color: var(--text-muted);
    margin-bottom: auto;
    line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
  }

  .h-footer {
    border-top: 1px solid var(--border-color);
    padding-top: 16px;
    margin-top: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .h-date { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }

  .h-actions { display: flex; gap: 8px; }

  /* Buttons */
  .btn-view {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-main);
    padding: 6px 16px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-view:hover {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: #fff;
  }

  /* DELETE BUTTON */
  .btn-delete {
    background: transparent;
    border: 1px solid var(--border-color);
    color: #ef4444; /* Red color */
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .btn-delete:hover {
    background: rgba(239, 68, 68, 0.15);
    border-color: #ef4444;
  }

  /* =========================================
     6. MODAL STYLES (Content Formatting)
     ========================================= */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    z-index: 2000;
    display: none; justify-content: center; align-items: center;
    opacity: 0; transition: opacity 0.3s ease;
  }
  .modal-overlay.active { display: flex; opacity: 1; }

  .modal-content {
    background: var(--bg-body);
    width: 90%; max-width: 800px; max-height: 85vh;
    border-radius: 24px; border: 1px solid var(--border-color);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    overflow-y: auto; padding: 40px; position: relative;
    transform: scale(0.95); transition: transform 0.3s ease;
  }
  .modal-overlay.active .modal-content { transform: scale(1); }

  .close-btn { 
    position: absolute; top: 20px; right: 25px; 
    font-size: 2rem; cursor: pointer; color: var(--text-muted); 
    transition: 0.2s; line-height: 1;
  }
  .close-btn:hover { color: var(--accent-primary); }

  /* Modal Internal Elements */
  .modal-title { 
    font-size: 2rem; font-weight: 800; 
    color: var(--accent-primary); margin-bottom: 20px; 
    border-bottom: 2px solid var(--border-color); padding-bottom: 15px; 
  }
  .section-head { 
    font-size: 1.3rem; font-weight: 700; color: var(--text-main); 
    margin-top: 24px; margin-bottom: 8px; 
  }
  .section-text { 
    color: var(--text-muted); line-height: 1.7; font-size: 1.05rem; 
  }
  ul { padding-left: 20px; color: var(--text-muted); line-height: 1.6; }
  li { margin-bottom: 8px; }

  /* Flashcard Item in Modal */
  .hist-flashcard {
    background: var(--nav-hover);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 12px;
    border-left: 4px solid var(--accent-secondary);
  }
  .fc-q { font-weight: 700; color: var(--text-main); margin-bottom: 6px; }
  .fc-a { color: var(--text-muted); }

  /* Mindmap Code Block */
  .code-block {
    background: rgba(0,0,0,0.3);
    padding: 20px;
    border-radius: 12px;
    color: #a5b4fc;
    font-family: monospace;
    overflow-x: auto;
    border: 1px solid var(--border-color);
  }

  .loader { width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; display: block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  /* Mobile */
  @media (max-width: 768px) {
    .sidebar { width: 70px; padding: 20px 10px; }
    .nav-links a span { display: none; }
    .nav-icon { margin: 0; font-size: 1.5rem; width: 100%; text-align: center; }
    .main-content { margin-left: 70px; padding: 20px; }
    .brand { display: none; }
  }

</style>
</head>
<body>

<aside class="sidebar">
  <div class="brand">AI Study</div>
  <nav class="nav-links">
    <a href="../index.html"><span class="nav-icon">üè†</span><span>Home</span></a>
    <a href="flashcards.html"><span class="nav-icon">‚ö°</span><span>Flashcards</span></a>
    <a href="mindmap.html"><span class="nav-icon">üß†</span><span>Mind Map</span></a>
    <a href="summarize.html"><span class="nav-icon">üìù</span><span>Summarize PDF</span></a>
    <a href="make-notes.html"><span class="nav-icon">‚úçÔ∏è</span><span>Make Notes</span></a>
    <a href="mcq.html"><span class="nav-icon">‚ùì</span><span>Make MCQ</span></a>
    <a href="explain.html"><span class="nav-icon">üí°</span><span>Explain</span></a>
    <a href="qna.html"><span class="nav-icon">üí¨</span><span>QnA</span></a>
    <a href="notes.html" class="active"><span class="nav-icon">üï∞Ô∏è</span><span>History</span></a>
    <div class="spacer"></div>
    <a href="profile.html"><span class="nav-icon">‚öôÔ∏è</span><span>Settings</span></a>
  </nav>
</aside>

<main class="main-content">
  
  <div class="top-bar">
    <button id="theme-btn" class="theme-toggle" title="Toggle Theme">
      <span id="theme-icon">üåô</span>
    </button>
  </div>

  <div class="page-header">
    <h1 class="h-gradient">Your History</h1>
    <p class="sub-text">Access your past summaries, notes, quizzes, and sessions.</p>
  </div>

  <div id="loader" class="loader"></div>
  <div id="history-list" class="history-grid"></div>

</main>

<div id="view-modal" class="modal-overlay">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

<script src="../config.js"></script>
<script>
(() => {
  // --- 1. THEME LOGIC ---
  const themeBtn = document.getElementById('theme-btn');
  const themeIcon = document.getElementById('theme-icon');
  const htmlEl = document.documentElement;

  const savedTheme = localStorage.getItem('ai_study_theme') || 'dark';
  htmlEl.setAttribute('data-theme', savedTheme);
  updateIcon(savedTheme);

  themeBtn.addEventListener('click', () => {
    const current = htmlEl.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    htmlEl.setAttribute('data-theme', next);
    localStorage.setItem('ai_study_theme', next);
    updateIcon(next);
  });

  function updateIcon(theme) {
    themeIcon.innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  }

  // --- 2. HISTORY LOGIC ---
  const API = window.API_BASE || "";
  const tokenKey = "ai_study_token";
  const listEl = document.getElementById("history-list");
  const loader = document.getElementById("loader");
  const modal = document.getElementById("view-modal");
  const modalBody = document.getElementById("modal-body");

  const esc = t => String(t||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  const parseBold = t => esc(t).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  async function loadHistory() {
    try {
      const headers = { "Content-Type": "application/json" };
      const token = localStorage.getItem(tokenKey);
      
      if(!token) { 
         listEl.innerHTML = `<p style="grid-column:1/-1; text-align:center;">Please <a href="login.html" style="color:var(--accent-primary)">Login</a> to view history.</p>`;
         loader.style.display = "none";
         return; 
      }
      
      headers["Authorization"] = "Bearer " + token;
      const resp = await fetch(`${API}/api/history/get`, { headers });
      
      if(resp.status === 401) {
         window.location.href = "login.html"; return;
      }

      const data = await resp.json();
      renderList(data.history || []);

    } catch(err) {
      listEl.innerHTML = `<p style="color:#ef4444; text-align:center; grid-column:1/-1;">Error: ${err.message}</p>`;
    } finally {
      loader.style.display = "none";
    }
  }

  function renderList(items) {
    if(!items || items.length === 0) {
      listEl.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:var(--text-muted);'>No history found yet.</p>";
      return;
    }

    window.historyItems = items; 

    listEl.innerHTML = items.map((item, index) => {
      let icon = "üìÑ";
      let label = "File";
      let title = "Untitled";
      let preview = "View content details...";
      
      const res = item.result || {};
      const inp = item.input || {};
      
      // Get ID securely (Backend might send _id or id)
      const itemId = item._id || item.id; 

      // --- SMART PREVIEW LOGIC ---
      if (item.type === 'pdf_summarize' || item.type === 'summarize') {
         icon = "üìë"; label = "Summary";
         title = res.summary?.title || inp.filename || "PDF Summary";
         preview = res.summary?.overview || "Document summary generated.";
      }
      else if (item.type === 'make_notes') {
         icon = "‚úçÔ∏è"; label = "Notes";
         title = res.notes_data?.title || "Study Notes";
         preview = res.notes_data?.summary || "Structured notes generated.";
      }
      else if (item.type === 'make_mcq') {
         icon = "‚ùì"; label = "Quiz";
         title = "MCQ Practice";
         preview = "Multiple choice questions generated.";
      }
      else if (item.type === 'qna') {
         icon = "üí¨"; label = "QnA";
         title = inp.question || "Question";
         preview = res.answer_data?.answer || "AI Response.";
      }
      else if (item.type === 'explain') {
         icon = "üí°"; label = "Explain";
         title = inp.topic || "Explanation";
         preview = "Deep dive explanation of topic.";
      }
      else if (item.type === 'mindmap') {
         icon = "üß†"; label = "Mind Map";
         title = inp.text?.substring(0,30) || "Mind Map";
         preview = "Visual flowchart generated.";
      }
      else if (item.type === 'flashcards') {
         icon = "üóÇÔ∏è"; label = "Flashcards";
         title = "Flashcard Deck";
         preview = "Study cards generated.";
      }

      // Truncate text for card view
      if(title.length > 50) title = title.substring(0, 50) + "...";
      if(typeof preview === 'string' && preview.length > 80) preview = preview.substring(0, 80) + "...";

      return `
        <div class="h-card" id="card-${index}">
          <div class="h-header">
             <div class="h-icon-box">${icon}</div>
             <div class="h-type">${label}</div>
          </div>
          <div class="h-title">${esc(title)}</div>
          <div class="h-preview">${esc(preview)}</div>
          <div class="h-footer">
             <span class="h-date">${new Date(item.created_at).toLocaleDateString()}</span>
             <div class="h-actions">
                <button class="btn-delete" title="Delete" onclick="deleteHistoryItem('${itemId}', ${index})">üóëÔ∏è</button>
                <button class="btn-view" onclick="openItem(${index})">Open</button>
             </div>
          </div>
        </div>
      `;
    }).join('');
  }

// --- 3. DELETE FUNCTION (FIXED) ---
  window.deleteHistoryItem = async (id, index) => {
      // Confirm action
      if(!confirm("Are you sure you want to delete this?")) return;

      const token = localStorage.getItem(tokenKey);
      if(!token) { alert("You must be logged in."); return; }

      // DEBUG: Check console to see if ID is correct
      console.log("Attempting to delete ID:", id); 

      try {
          const resp = await fetch(`${API}/api/history/${id}`, {
              method: "DELETE",
              headers: { "Authorization": "Bearer " + token }
          });

          if(resp.ok) {
              // Success: Remove visually
              const card = document.getElementById(`card-${index}`);
              if(card) {
                  card.style.opacity = '0'; 
                  setTimeout(() => card.remove(), 300);
              }
          } else {
              // Failure: Show exact error
              const err = await resp.json();
              alert(`Delete Failed: ${err.error || resp.statusText}`);
              console.error("Server Error:", err);
          }
      } catch(e) {
          console.error("Network Error:", e);
          alert("Network error. Check console for details.");
      }
  };

  // --- 4. MODAL CONTENT RENDERER ---
  window.openItem = (index) => {
    const item = window.historyItems[index];
    const data = item.result;
    const inp = item.input || {};
    let html = "";

    // 1. FLASHCARDS
    if(item.type === 'flashcards') {
       const cards = data.flashcards || data; 
       html += `<div class="modal-title">Flashcards</div>`;
       if(Array.isArray(cards)) {
         cards.forEach((c, i) => {
            html += `
              <div class="hist-flashcard">
                 <div class="fc-q">Q: ${esc(c.front)}</div>
                 <div class="fc-a">A: ${esc(c.back)}</div>
              </div>`;
         });
       }
    }
    // 2. EXPLAIN TOPIC
    else if (item.type === 'explain') {
        const exp = data.explanation || data;
        html += `<div class="modal-title">${esc(inp.topic || "Explanation")}</div>`;
        
        if(Array.isArray(exp)) {
            exp.forEach(sec => {
                html += `<div class="section-head">${esc(sec.title)}</div>`;
                html += `<p class="section-text">${esc(sec.paragraph)}</p>`;
                if(sec.bullets) {
                    html += `<ul>${sec.bullets.map(b => `<li>${esc(b)}</li>`).join('')}</ul>`;
                }
            });
        }
    }
    // 3. MIND MAP
    else if (item.type === 'mindmap') {
        const code = data.mermaid_code || data.mindmap;
        html += `<div class="modal-title">Mind Map Structure</div>`;
        html += `<div class="code-block">${esc(code)}</div>`;
        html += `<p style="margin-top:10px; opacity:0.7;">Copy this code into a Mermaid viewer to visualize.</p>`;
    }
    // 4. SUMMARIZE PDF
    else if(item.type === 'pdf_summarize' || item.type === 'summarize') {
       const sum = data.summary || data;
       html += `<div class="modal-title">${esc(sum.title || "Summary")}</div>`;
       html += `<p style="margin-bottom:20px;">${esc(sum.overview || "")}</p>`;
       if(sum.sections) {
         sum.sections.forEach(sec => {
           html += `<div class="section-head">${esc(sec.heading)}</div>`;
           html += `<p class="section-text">${esc(sec.content)}</p>`;
           if(sec.bullets) html += `<ul>${sec.bullets.map(b=>`<li>${esc(b)}</li>`).join('')}</ul>`;
         });
       }
    }
    // 5. NOTES
    else if(item.type === 'make_notes') {
       const note = data.notes_data || data;
       html += `<div class="modal-title">${esc(note.title || "Notes")}</div>`;
       if(note.sections) {
         note.sections.forEach(sec => {
            html += `<div class="section-head">${esc(sec.heading)}</div>`;
            html += `<ul>${sec.points.map(p=>`<li>${parseBold(p)}</li>`).join('')}</ul>`;
         });
       } else if (data.notes) {
          html += `<pre style="white-space:pre-wrap; color:var(--text-muted);">${esc(data.notes)}</pre>`;
       }
    }
    // 6. QnA
    else if(item.type === 'qna') {
       const qna = data.answer_data || data;
       html += `<div class="modal-title">Question & Answer</div>`;
       html += `<div class="section-head">Question</div><p class="section-text"><b>${esc(inp.question)}</b></p>`;
       html += `<div class="section-head">Answer</div><p class="section-text">${parseBold(qna.answer)}</p>`;
    }
    // 7. MCQ
    else if(item.type === 'make_mcq') {
       const mcqs = data.mcqs_data || data.mcqs;
       html += `<div class="modal-title">Quiz</div>`;
       if(Array.isArray(mcqs)){
         mcqs.forEach((q,i) => {
            html += `<div style="background:var(--nav-hover); padding:16px; border-radius:12px; margin-bottom:16px;">`;
            html += `<div style="font-weight:bold; margin-bottom:8px;">${i+1}. ${esc(q.question)}</div>`;
            html += `<ul>${q.options.map(o => {
               const isCorrect = o === q.correctAnswer;
               return `<li style="${isCorrect ? 'color:var(--accent-primary); font-weight:bold;' : ''}">${esc(o)}</li>`;
            }).join('')}</ul>`;
            html += `</div>`;
         });
       }
    }
    // FALLBACK
    else {
       html += `<div class="modal-title">${item.type.toUpperCase()}</div>`;
       html += `<pre style="white-space:pre-wrap; color:var(--text-muted);">${esc(JSON.stringify(data, null, 2))}</pre>`;
    }

    modalBody.innerHTML = html;
    modal.classList.add("active");
  };

  window.closeModal = () => modal.classList.remove("active");

  loadHistory();
})();
</script>

</body>
</html>