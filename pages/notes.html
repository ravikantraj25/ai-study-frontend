<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>History â€” AI Study</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../styles.css">

<style>
  .page-wrapper { max-width:960px; margin:36px auto; }
  
  .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
  
  /* History Card */
  .h-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 20px;
    transition: 0.2s;
    display: flex;
    flex-direction: column;
  }
  .h-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.06); }
  
  .h-type { font-size: 0.75rem; text-transform: uppercase; color: #a5b4fc; margin-bottom: 8px; font-weight: 700; letter-spacing: 1px; }
  .h-title { font-size: 1.1rem; font-weight: 700; color: #fff; margin-bottom: 10px; line-height: 1.4; }
  .h-date { font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: auto; padding-top: 15px; }
  
  .btn-view {
    margin-top: 15px;
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background: rgba(127, 90, 240, 0.2);
    color: #a5b4fc;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-view:hover { background: #7f5af0; color: #fff; }

  /* Modal Styles */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
    z-index: 100; display: none; justify-content: center; align-items: center;
  }
  .modal-overlay.active { display: flex; }
  
  .modal-content {
    background: #16161a;
    width: 90%; max-width: 800px; max-height: 90vh;
    border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
    overflow-y: auto; padding: 30px; position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  }
  .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #fff; }

  /* Re-using styles from other pages for the modal content */
  .section-head { color: #5eead4; font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; margin-top: 20px; }
  .section-text { color: #ddd; line-height: 1.6; }
  .chip { display:inline-block; padding:4px 10px; background:rgba(255,255,255,0.1); border-radius:12px; font-size:0.8rem; margin-right:5px; margin-bottom:5px; }

</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">AI Study</div>
  <a href="../index.html">Home</a>
  <a href="summarize.html">Summarize PDF</a>
  <a href="make-notes.html">Make Notes</a>
  <a href="mcq.html">Make MCQ</a>
  <a href="explain.html">Explain</a>
  <a href="qna.html">QnA</a>
  <a href="notes.html" class="active">History</a>
  <div class="spacer"></div>
  <a href="profile.html">Update Profile</a>
  <a href="delete-account.html">Delete Account</a>
</aside>

<main class="content-with-sidebar">
  <div class="page-wrapper container">
    <h1 class="h-gradient">Your History</h1>
    <p class="center mt-8">Access your past summaries, notes, and QnA sessions.</p>

    <div id="history-list" class="history-grid mt-18"></div>
    <div id="loader" class="loader" style="margin: 20px auto; display:block;"></div>
  </div>
</main>

<div id="view-modal" class="modal-overlay">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

<script src="../config.js"></script>
<script>
(() => {
  const API = window.API_BASE || "";
  const tokenKey = "ai_study_token";
  const listEl = document.getElementById("history-list");
  const loader = document.getElementById("loader");
  const modal = document.getElementById("view-modal");
  const modalBody = document.getElementById("modal-body");

  // Format Helper
  const esc = t => String(t||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

  // --- 1. FETCH HISTORY ---
  async function loadHistory() {
    try {
      const headers = { "Content-Type": "application/json" };
      const token = localStorage.getItem(tokenKey);
      if(!token) { window.location.href = "login.html"; return; }
      
      headers["Authorization"] = "Bearer " + token;

      const resp = await fetch(API + "/history", { headers });
      if(resp.status === 401) { window.location.href = "login.html"; return; }

      const data = await resp.json();
      renderList(data.history || []);

    } catch(err) {
      listEl.innerHTML = `<p style="color:#ff4d6d">Error loading history.</p>`;
    } finally {
      loader.style.display = "none";
    }
  }

  // --- 2. RENDER CARD LIST ---
  function renderList(items) {
    if(items.length === 0) {
      listEl.innerHTML = "<p class='center' style='grid-column:1/-1'>No history found.</p>";
      return;
    }

    listEl.innerHTML = items.map((item, index) => {
      // Determine Display Title
      let title = "Generated Content";
      let typeLabel = item.type || "Unknown";

      if(item.input) {
        if(item.input.filename) title = item.input.filename;
        else if(item.input.topic) title = item.input.topic;
        else if(item.input.question) title = item.input.question;
        else if(item.input.text) title = item.input.text.substring(0, 50) + "...";
      }

      // We attach the JSON data to the button using a data attribute logic or ID lookup
      // Simpler approach: store data in global array or just pass ID if needed. 
      // For simplicity here, we attach index.
      return `
        <div class="h-card">
          <div class="h-type">${esc(typeLabel)}</div>
          <div class="h-title">${esc(title)}</div>
          <div class="h-date">${new Date(item.created_at).toLocaleDateString()}</div>
          <button class="btn-view" onclick="openItem(${index})">View Result</button>
        </div>
      `;
    }).join('');
    
    // Store items globally to access in modal
    window.historyItems = items;
  }

  // --- 3. OPEN MODAL & RENDER CONTENT ---
  window.openItem = (index) => {
    const item = window.historyItems[index];
    const data = item.result;
    
    let html = "";

    // -- A. Summary Handler --
    if(item.type === 'pdf_summarize' || data.sections) {
       // Handle wrapper if present
       const sum = data.summary || data; 
       html += `<h2>${esc(sum.title || "Document Summary")}</h2>`;
       html += `<p style="opacity:0.8; margin-bottom:20px">${esc(sum.overview || "")}</p>`;
       
       if(sum.sections) {
         sum.sections.forEach(sec => {
           html += `<div class="section-head">${esc(sec.heading)}</div>`;
           html += `<p class="section-text">${esc(sec.content)}</p>`;
           if(sec.bullets) {
             html += `<ul>${sec.bullets.map(b=>`<li>${esc(b)}</li>`).join('')}</ul>`;
           }
         });
       }
    } 
    // -- B. Notes Handler --
    else if (item.type === 'make_notes' || data.notes || data.notes_data) {
       const note = data.notes_data || data.notes || data;
       html += `<h2>${esc(note.title || "Study Notes")}</h2>`;
       html += `<p style="opacity:0.8">${esc(note.summary || "")}</p>`;
       
       if(note.sections) {
         note.sections.forEach(sec => {
           html += `<div class="section-head">${esc(sec.heading)}</div>`;
           html += `<ul>${sec.points.map(p=>`<li>${esc(p)}</li>`).join('')}</ul>`;
         });
       } else if (typeof note === 'string') {
         html += `<pre style="white-space:pre-wrap">${esc(note)}</pre>`;
       }
    }
    // -- C. QnA Handler --
    else if (item.type === 'qna' || data.answer) {
       const qna = data.answer_data || data;
       html += `<h2>QnA Result</h2>`;
       html += `<div class="section-head">Answer</div>`;
       html += `<p class="section-text">${esc(qna.answer)}</p>`;
       if(qna.evidence) {
         html += `<div class="section-head">Evidence</div>`;
         html += `<p style="font-style:italic">"${esc(qna.evidence)}"</p>`;
       }
    }
    // -- D. Fallback --
    else {
      html += `<pre>${esc(JSON.stringify(data, null, 2))}</pre>`;
    }

    modalBody.innerHTML = html;
    modal.classList.add("active");
  };

  window.closeModal = () => {
    modal.classList.remove("active");
  };

  loadHistory();
})();
</script>
</body>
</html>