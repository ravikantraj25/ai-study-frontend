<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Make MCQ ‚Äî AI Study</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../styles.css">

<style>
  .page-wrapper { max-width:980px; margin:36px auto; padding: 0 20px; }

  /* Input Card */
  .card {
    padding:24px;
    border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    box-shadow:0 10px 30px rgba(2,6,23,0.55);
    border: 1px solid rgba(255,255,255,0.05);
  }

  textarea {
    width:100%;
    padding:16px;
    border-radius:12px;
    background:rgba(0,0,0,0.2);
    border:1px solid rgba(255,255,255,0.1);
    color:inherit;
    resize:vertical;
    font-family: inherit;
    line-height: 1.5;
    transition: 0.2s;
  }
  textarea:focus { 
    border-color: #7f5af0; 
    outline: none; 
    background:rgba(0,0,0,0.3); 
  }

  /* Controls Row */
  .controls-row {
    display:flex; 
    gap:16px; 
    align-items:center; 
    margin-top:20px; 
    flex-wrap:wrap;
  }

  .input-group {
    display:flex; 
    align-items:center; 
    background:rgba(255,255,255,0.05); 
    padding:8px 16px; 
    border-radius:12px;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .btn-primary {
    padding:12px 24px;
    border-radius:12px;
    border:none;
    background:linear-gradient(90deg,#7f5af0,#5eead4);
    color:#021;
    font-weight:700;
    cursor:pointer;
    transition: transform 0.1s;
  }
  .btn-primary:active { transform: scale(0.96); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

  .loader {
    width:20px;
    height:20px;
    border-radius:50%;
    border:3px solid rgba(255,255,255,0.1);
    border-top-color:#5eead4;
    animation:spin 900ms linear infinite;
  }
  .hidden { display:none; }

  /* --- MCQ QUIZ UI --- */
  .mcq-card {
    margin-top:24px;
    padding:24px;
    border-radius:16px;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.05);
    animation: slideUp 0.4s ease-out;
  }

  .mcq-question {
    font-size: 1.15rem;
    font-weight:600;
    margin-bottom:20px;
    line-height: 1.5;
    color: #fff;
  }

  /* Options */
  .mcq-option {
    padding:16px;
    background:rgba(255,255,255,0.03);
    margin-bottom:12px;
    border-radius:12px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    font-size: 1rem;
  }

  .mcq-option:hover {
    background:rgba(255,255,255,0.06);
    transform: translateX(4px);
  }

  /* --- STATES --- */
  
  /* User Selected CORRECT */
  .mcq-option.selected-correct {
    background: rgba(45, 212, 191, 0.15); 
    border-color: #2dd4bf; /* Teal-400 */
    color: #5eead4;
  }

  /* User Selected WRONG */
  .mcq-option.selected-wrong {
    background: rgba(248, 113, 113, 0.15); 
    border-color: #f87171; /* Red-400 */
    color: #fca5a5;
  }

  /* Reveal Correct Answer (when user gets it wrong) */
  .mcq-option.reveal-correct {
    border-color: #2dd4bf;
    box-shadow: 0 0 15px rgba(45, 212, 191, 0.2);
  }

  /* Locked State (After answering) */
  .mcq-card.answered { opacity: 0.95; }
  .mcq-card.answered .mcq-option {
    cursor: default;
    pointer-events: none; 
  }
  .mcq-card.answered .mcq-option:hover { transform: none; }

  /* Explanation Box */
  .explanation-box {
    margin-top: 16px;
    padding: 16px;
    border-radius: 12px;
    background: rgba(127, 90, 240, 0.15);
    font-size: 0.95rem;
    color: #e0e7ff;
    border-left: 4px solid #7f5af0;
    display: none; 
    line-height: 1.5;
  }
  .explanation-box.visible { display: block; animation: fadeIn 0.3s ease; }

  /* Score Badge */
  .scoreboard {
    background: #7f5af0;
    color: white;
    padding: 8px 16px;
    border-radius: 30px;
    font-weight: 700;
    font-size: 0.95rem;
    margin-left: auto;
    box-shadow: 0 4px 15px rgba(127, 90, 240, 0.4);
    display: flex;
    gap: 8px;
    align-items: center;
  }

  @keyframes spin { to { transform:rotate(360deg); } }
  @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
</style>
</head>

<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">AI Study</div>
  <a href="../index.html">Home</a>
  <a href="flashcards.html">Flashcards</a>
  <a href="mindmap.html" class="active">Mind Map</a>
  <a href="summarize.html">Summarize PDF</a>
  <a href="make-notes.html">Make Notes</a>
  <a href="mcq.html" class="active">Make MCQ</a>
  <a href="explain.html">Explain</a>
  <a href="qna.html">QnA</a>
  <a href="notes.html">Notes History</a>
  <div class="spacer"></div>
  <a href="profile.html">Update Profile</a>
  <a href="delete-account.html">Delete Account</a>
</aside>

<main class="content-with-sidebar">
  <div class="page-wrapper container">
    <h1 class="h-gradient">MCQ Quiz Mode</h1>
    <p class="center mt-8">Generate a quiz, test your knowledge instantly, and track your score.</p>

    <div class="card mt-18">
      <textarea id="mcq-text" rows="6" placeholder="Paste your study material here (e.g., lecture notes, article, or chapter text)..."></textarea>

      <div class="controls-row">
        
        <div class="input-group">
            <label for="mcq-count" style="font-size:0.9rem; margin-right:10px; color:rgba(255,255,255,0.7);">Questions:</label>
            <input id="mcq-count" type="number" min="1" max="20" value="5"
              style="width:40px; border:none; background:transparent; color:white; font-weight:bold; text-align:center; outline:none;">
        </div>

        <button id="mcq-submit" class="btn-primary">Generate Quiz</button>
        <span id="mcq-loader" class="loader hidden"></span>
        
        <div id="score-display" class="scoreboard hidden">
           <span>üèÜ Score:</span>
           <span id="current-score">0</span> / <span id="total-qs">0</span>
        </div>
      </div>
    </div>

    <div id="mcq-result" style="padding-bottom: 60px;"></div>
  </div>
</main>

<script src="../config.js"></script>

<script>
(() => {

  const API = window.API_BASE || ""; 
  const btn = document.getElementById("mcq-submit");
  const loader = document.getElementById("mcq-loader");
  const out = document.getElementById("mcq-result");
  const textEl = document.getElementById("mcq-text");
  const countEl = document.getElementById("mcq-count");
  const scoreDisplay = document.getElementById("score-display");
  const currentScoreEl = document.getElementById("current-score");
  const totalQsEl = document.getElementById("total-qs");
  const tokenKey = "ai_study_token";

  let score = 0;

  // HTML Escape Helper
  const esc = t => String(t || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));

  // --------------------------
  // GAME LOGIC: Handle Answer Click
  // --------------------------
  // We attach this to window so the HTML onclick attributes can find it
  window.checkAnswer = (element, isCorrect, cardId) => {
      const card = document.getElementById(cardId);
      if (card.classList.contains("answered")) return; // Already answered

      // Lock card
      card.classList.add("answered");

      // Show Explanation
      const explBox = card.querySelector(".explanation-box");
      if (explBox) explBox.classList.add("visible");

      if (isCorrect) {
          // ‚úÖ Correct
          element.classList.add("selected-correct");
          score++;
          currentScoreEl.innerText = score;
          
          // Add Checkmark
          const icon = document.createElement("span");
          icon.style.marginLeft = "auto";
          icon.innerHTML = "‚úÖ";
          element.appendChild(icon);
      } else {
          // ‚ùå Wrong
          element.classList.add("selected-wrong");
          const icon = document.createElement("span");
          icon.style.marginLeft = "auto";
          icon.innerHTML = "‚ùå";
          element.appendChild(icon);

          // Reveal the REAL correct answer
          const options = card.querySelectorAll(".mcq-option");
          options.forEach(opt => {
              if (opt.dataset.isCorrect === "true") {
                  opt.classList.add("reveal-correct");
                  // Add text tag
                  const tag = document.createElement("span");
                  tag.style.marginLeft = "auto";
                  tag.style.fontSize = "0.8em";
                  tag.style.opacity = "0.8";
                  tag.innerText = "(Correct Answer)";
                  opt.appendChild(tag);
              }
          });
      }
  };

  // --------------------------
  // GENERATE MCQS
  // --------------------------
  btn.addEventListener("click", async () => {

    // Reset UI
    out.innerHTML = "";
    scoreDisplay.classList.add("hidden");
    score = 0;
    currentScoreEl.innerText = "0";

    const text = textEl.value.trim();
    let count = parseInt(countEl.value);
    if (isNaN(count) || count < 1) count = 5;
    if (count > 20) count = 20;

    if (!text) {
      out.innerHTML = "<p style='color:#ff4d6d; margin-top:20px; text-align:center'>Please paste some text to generate questions.</p>";
      return;
    }

    loader.classList.remove("hidden");
    btn.disabled = true;

    try {
      const headers = { "Content-Type": "application/json" };
      const token = localStorage.getItem(tokenKey);
      if (token) headers["Authorization"] = "Bearer " + token;

      // üëá FIXED: Added /api/study prefix
      const resp = await fetch(`${API}/api/study/make-mcq`, {
        method: "POST",
        headers,
        body: JSON.stringify({ text, num_questions: count })
      });

      const data = await resp.json();
      if (data.error) throw new Error(data.error);

      const list = data.mcqs; 
      if (!list || list.length === 0) {
          out.innerHTML = "<p style='margin-top:20px; text-align:center'>No MCQs generated. Try different text.</p>";
          return;
      }

      // Show Scoreboard
      totalQsEl.innerText = list.length;
      scoreDisplay.classList.remove("hidden");

      // Render Cards
      let html = "";
      list.forEach((q, i) => {
        const cardId = `mcq-card-${i}`;
        
        html += `
          <div class="mcq-card" id="${cardId}">
            <div class="mcq-question">
                <span style="color:#7f5af0; margin-right:8px;">${i+1}.</span> ${esc(q.question)}
            </div>

            <div style="display:flex; flex-direction:column;">
                ${q.options.map((opt, idx) => {
                    const isCorrect = opt === q.correctAnswer;
                    
                    return `
                      <div class="mcq-option" 
                           data-is-correct="${isCorrect}"
                           onclick="checkAnswer(this, ${isCorrect}, '${cardId}')">
                        <strong style="margin-right:12px; opacity:0.6;">${String.fromCharCode(65 + idx)}</strong> 
                        ${esc(opt)}
                      </div>
                    `;
                }).join("")}
            </div>

            ${q.explanation ? `
                <div class="explanation-box">
                  <strong>üí° Explanation:</strong> ${esc(q.explanation)}
                </div>
            ` : ''}
          </div>
        `;
      });

      out.innerHTML = html;

    } catch(err) {
      console.error(err);
      out.innerHTML = `<p style='color:#ff4d6d; margin-top:20px; text-align:center'>Error: ${esc(err.message)}</p>`;
    } finally {
      loader.classList.add("hidden");
      btn.disabled = false;
    }

  });

})();
</script>

</body>
</html>