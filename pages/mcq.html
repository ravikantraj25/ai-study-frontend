<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Make MCQ — AI Study</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../styles.css">

<style>
  .page-wrapper { max-width:980px; margin:36px auto; }

  .card {
    padding:18px;
    border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow:0 10px 30px rgba(2,6,23,0.55);
  }

  textarea {
    width:100%;
    padding:12px;
    border-radius:12px;
    background:transparent;
    border:1px solid rgba(255,255,255,0.06);
    color:inherit;
    resize:vertical;
  }

  .btn-primary {
    padding:10px 16px;
    border-radius:12px;
    border:none;
    background:linear-gradient(90deg,#7f5af0,#5eead4);
    color:#021;
    font-weight:700;
    cursor:pointer
  }

  .loader {
    width:16px;
    height:16px;
    border-radius:50%;
    border:3px solid rgba(255,255,255,0.08);
    border-top-color:#7f5af0;
    animation:spin 900ms linear infinite;
    display:inline-block;
  }

  .hidden { display:none; }

  /* MCQ UI */
  .mcq-card {
    margin-top:18px;
    padding:18px;
    border-radius:14px;
    background:rgba(255,255,255,0.03);
    box-shadow:0 6px 20px rgba(2,6,23,0.5);
  }

  .mcq-question {
    font-size:18px;
    font-weight:700;
    margin-bottom:12px;
  }

  .mcq-option {
    padding:10px 14px;
    background:rgba(255,255,255,0.06);
    margin-bottom:8px;
    border-radius:10px;
    transition:0.25s;
  }

  .mcq-option:hover {
    background:rgba(255,255,255,0.12);
  }

  .correct {
    border-left:4px solid #5eead4;
  }

  @keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>

<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">AI Study</div>
  <a href="../index.html">Home</a>
  <a href="summarize.html">Summarize PDF</a>
  <a href="make-notes.html">Make Notes</a>
  <a href="mcq.html" class="active">Make MCQ</a>
  <a href="explain.html">Explain</a>
  <a href="qna.html">QnA</a>
  <a href="notes.html">Notes History</a>
  <div class="spacer"></div>
  <a href="profile.html">Update Profile</a>
  <a href="delete-account.html">Delete Account</a>
</aside>

<main class="content-with-sidebar">
  <div class="page-wrapper container">
    <h1 class="h-gradient">MCQ Generator</h1>
    <p class="center mt-8">Turn a topic or text into practice MCQs — choose number of questions.</p>

    <div class="card mt-18">
      <textarea id="mcq-text" rows="6" placeholder="Enter topic or paste text..."></textarea>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <input id="mcq-count" type="number" min="1" max="30" value="5"
          style="width:96px;padding:8px;border-radius:10px;background:transparent;
                 border:1px solid rgba(255,255,255,0.06)">
        <button id="mcq-submit" class="btn-primary">Generate MCQs</button>
        <span id="mcq-loader" class="loader hidden"></span>
        <div style="flex:1"></div>
        <small style="opacity:0.7">Tip: short focused text gives better MCQs.</small>
      </div>
    </div>

    <div id="mcq-result"></div>
  </div>
</main>

<script src="../config.js"></script>

<script>
(() => {

  const API = window.API_BASE || "";
  const btn = document.getElementById("mcq-submit");
  const loader = document.getElementById("mcq-loader");
  const out = document.getElementById("mcq-result");
  const textEl = document.getElementById("mcq-text");
  const countEl = document.getElementById("mcq-count");
  const tokenKey = "ai_study_token";

  function show(e){ e.classList.remove("hidden"); }
  function hide(e){ e.classList.add("hidden"); }

  function esc(t){
    return String(t||"").replace(/[&<>"']/g, m =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])
    );
  }

  // --------------------------
  // STRING → STRUCTURED MCQs
  // --------------------------
  // --------------------------
// PARSE BACKEND STRING
// --------------------------
function parseMCQString(str) {
    // Remove header text if present
    str = str.replace("Here are 5 MCQs based on the given text:", "").trim();

    // Split MCQs based on the "MCQ X" pattern
    const groups = str.split(/MCQ\s+\d+/).filter(g => g.trim() !== "");

    const mcqs = [];

    groups.forEach(group => {
        const lines = group.trim().split("\n").map(l => l.trim()).filter(l => l);

        let question = lines[0]; // first line = question
        let options = [];
        let answer = "";

        // Parse options and answer
        lines.forEach(line => {
            if (/^[A-D]\)/.test(line)) {
                // A) option text
                options.push(line.substring(3).trim());
            }

            if (line.toLowerCase().startsWith("correct answer")) {
                answer = line.split(":")[1].trim();
                // remove "B)" etc.
                answer = answer.replace(/^[A-D]\)/, "").trim();
            }
        });

        mcqs.push({ question, options, answer });
    });

    return mcqs;
}


  // --------------------------
  // MAIN BUTTON EVENT
  // --------------------------
  btn.addEventListener("click", async ()=>{

    out.innerHTML = "";
    const text = textEl.value.trim();
    const count = Number(countEl.value);

    if(!text){
      out.innerHTML = "<p style='color:#ff4d6d'>Enter topic or text.</p>";
      return;
    }

    show(loader);
    btn.disabled = true;

    try {
      const headers = { "Content-Type": "application/json" };
      const token = localStorage.getItem(tokenKey);
      if(token) headers["Authorization"] = "Bearer " + token;

      const resp = await fetch(API + "/make-mcq", {
        method: "POST",
        headers,
        body: JSON.stringify({ text, count })
      });

      const data = await resp.json();

      // Backend gives STRING
      // Convert string → Array
      const list = parseMCQString(data.mcqs);

      // Build UI
      let html = "";
      list.forEach((q, i) => {
        html += `
          <div class="mcq-card">
            <div class="mcq-question">MCQ ${i+1}: ${esc(q.question)}</div>

            ${q.options
              .map((opt, idx) => `
                <div class="mcq-option ${q.answer === opt ? "correct" : ""}">
                  ${String.fromCharCode(65 + idx)}) ${esc(opt)}
                </div>
              `).join("")}
          </div>
        `;
      });

      out.innerHTML = html;

    } catch(err) {
      out.innerHTML = "<p style='color:#ff4d6d'>Error: " + esc(err.message) + "</p>";
    } finally {
      hide(loader);
      btn.disabled = false;
    }

  });

})();
</script>

</body>
</html>
