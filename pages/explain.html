<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Explain Topic â€” AI Study</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../styles.css">
<style>
  .page-wrapper { max-width:920px; margin:36px auto; }
  
  /* Main Input Card */
  .card { 
    padding:24px; 
    border-radius:16px; 
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
    box-shadow:0 10px 30px rgba(2,6,23,0.55); 
    border: 1px solid rgba(255,255,255,0.05);
  }

  input[type="text"] { 
    width:100%; 
    padding:14px; 
    border-radius:12px; 
    background:rgba(0,0,0,0.2); 
    border:1px solid rgba(255,255,255,0.1); 
    color:inherit; 
    font-size: 1rem;
    transition: 0.2s;
  }
  input[type="text"]:focus {
    border-color: #7f5af0;
    outline: none;
    background:rgba(0,0,0,0.3);
  }

  .btn-primary { 
    padding:12px 20px; 
    border-radius:12px; 
    border:none; 
    background:linear-gradient(90deg,#7f5af0,#5eead4); 
    color:#021; 
    font-weight:700; 
    cursor:pointer;
    transition: transform 0.1s;
  }
  .btn-primary:active { transform: scale(0.96); }

  .loader { 
    width:20px; height:20px; border-radius:50%; 
    border:3px solid rgba(255,255,255,0.1); 
    border-top-color:#5eead4; 
    animation:spin 900ms linear infinite; 
    display:inline-block 
  }
  
  .hidden { display:none }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* ----------------------- */
  /* NEW EXPLANATION STYLES */
  /* ----------------------- */
  
  .explain-section {
    margin-bottom: 24px;
    padding: 24px;
    border-radius: 16px;
    background: rgba(255,255,255,0.02); /* Subtle glass effect */
    border: 1px solid rgba(255,255,255,0.04);
    animation: fadeIn 0.4s ease-out;
  }

  .explain-title {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 12px;
    background: linear-gradient(90deg, #fff, #a5b4fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .explain-text {
    font-size: 1.05rem;
    line-height: 1.6;
    color: rgba(255,255,255,0.9);
    margin-bottom: 16px;
  }

  /* Bullet Points */
  .explain-list {
    margin: 12px 0 20px 20px;
    color: rgba(255,255,255,0.8);
  }
  .explain-list li { margin-bottom: 6px; }

  /* Example Box (Analogies) */
  .example-box {
    background: rgba(127, 90, 240, 0.1); /* Purple tint */
    border-left: 4px solid #7f5af0;
    padding: 16px;
    border-radius: 0 12px 12px 0;
    margin-bottom: 20px;
  }
  .example-header {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #a5b4fc;
    font-weight: 700;
    margin-bottom: 8px;
  }

  /* Important Terms Chips */
  .terms-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
  }
  .term-chip {
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(94, 234, 212, 0.1); /* Teal tint */
    border: 1px solid rgba(94, 234, 212, 0.3);
    color: #5eead4;
    font-size: 0.85rem;
    font-weight: 500;
  }

  /* FAQ Accordion Style */
  .faq-container {
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 16px;
  }
  .faq-item:not(:last-child) {
    margin-bottom: 14px;
    padding-bottom: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .faq-q {
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
  }
  .faq-a {
    color: rgba(255,255,255,0.7);
    font-size: 0.95rem;
  }

  @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">AI Study</div>
  <a href="../index.html">Home</a>
  <a href="flashcards.html">Flashcards</a>
  <a href="summarize.html">Summarize PDF</a>
  <a href="make-notes.html">Make Notes</a>
  <a href="mcq.html">Make MCQ</a>
  <a href="explain.html" class="active">Explain</a>
  <a href="qna.html">QnA</a>
  <a href="notes.html">Notes History</a>
  <div class="spacer"></div>
  <a href="profile.html">Update Profile</a>
  <a href="delete-account.html">Delete Account</a>
</aside>

<main class="content-with-sidebar">
  <div class="page-wrapper container">
    <h1 class="h-gradient">Explain Topic</h1>
    <p class="center mt-8">Deep explanations with analogies, examples, and simple breakdowns.</p>

    <div class="card mt-18">
      <input id="explain-topic" type="text" placeholder="Enter topic (e.g. How does a Blockchain work?)" />
      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <button id="explain-btn" class="btn-primary">Explain It</button>
        <span id="explain-loader" class="loader hidden" aria-hidden="true"></span>
      </div>
    </div>

    <div id="explain-result" style="margin-top: 30px;"></div>
  </div>
</main>

<script src="../config.js"></script>
<script>
(() => {
  const API = window.API_BASE || "";
  const tokenKey = "ai_study_token";
  const topicEl = document.getElementById("explain-topic");
  const btn = document.getElementById("explain-btn");
  const loader = document.getElementById("explain-loader");
  const out = document.getElementById("explain-result");

  function show(l){ l.classList.remove("hidden"); }
  function hide(l){ l.classList.add("hidden"); }
  
  // Safe HTML escaper
  function esc(t){ 
    return String(t||"").replace(/[&<>"']/g, m=>({ 
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" 
    }[m])); 
  }

  // ----------------------------------------------------
  //  FORMATTER: Converts JSON blocks to Beautiful HTML
  // ----------------------------------------------------
  function explainFormatter(blocks){
    if(!Array.isArray(blocks)) {
      // Fallback if not JSON array
      return "<pre style='color:#fff'>"+esc(JSON.stringify(blocks,null,2))+"</pre>";
    }

    let html = "";

    blocks.forEach(sec => {
      html += `<div class="explain-section">`;

      // 1. Title
      if(sec.title) html += `<div class="explain-title">${esc(sec.title)}</div>`;

      // 2. Main Paragraph
      if(sec.paragraph) html += `<div class="explain-text">${esc(sec.paragraph)}</div>`;

      // 3. Important Terms (Chips)
      if(sec.important_terms && sec.important_terms.length > 0) {
        html += `<div class="terms-container">`;
        sec.important_terms.forEach(term => {
           html += `<span class="term-chip">${esc(term)}</span>`;
        });
        html += `</div>`;
      }

      // 4. Bullet Points
      if(sec.bullets && sec.bullets.length > 0){
        html += `<ul class="explain-list">`;
        sec.bullets.forEach(b => html += `<li>${esc(b)}</li>`);
        html += `</ul>`;
      }

      // 5. Examples / Analogies (Highlighted Box)
      if(sec.examples && sec.examples.length > 0){
        html += `<div class="example-box">`;
        html += `<div class="example-header">Examples & Analogies</div>`;
        html += `<ul style="padding-left:18px; margin:0;">`;
        sec.examples.forEach(e => html += `<li style="margin-bottom:4px">${esc(e)}</li>`);
        html += `</ul></div>`;
      }

      // 6. FAQs (Bottom Section)
      if(sec.faqs && sec.faqs.length > 0){
        html += `<div class="faq-container">`;
        sec.faqs.forEach(f => {
          html += `<div class="faq-item">
                     <div class="faq-q">Q: ${esc(f.q)}</div>
                     <div class="faq-a">${esc(f.a)}</div>
                   </div>`;
        });
        html += `</div>`;
      }

      html += `</div>`; // End Section
    });

    return html;
  }

  // ----------------------------------------------------
  //  FETCH LOGIC
  // ----------------------------------------------------
  btn.addEventListener("click", async () => {
    out.innerHTML = "";
    const topic = (topicEl.value || "").trim();
    if(!topic){ 
      out.innerHTML = "<p style='color:#ff4d6d; text-align:center'>Please enter a topic.</p>"; 
      return; 
    }

    show(loader); 
    btn.disabled = true;

    try {
      const headers = { "Content-Type":"application/json" };
      const token = localStorage.getItem(tokenKey);
      if(token) headers["Authorization"] = "Bearer " + token;

      // ðŸ‘‡ðŸ‘‡ðŸ‘‡ FIX IS HERE ðŸ‘‡ðŸ‘‡ðŸ‘‡
      // Was: "/explain" -> Now: "/api/study/explain"
      const resp = await fetch((API||"") + "/api/study/explain", { 
        method:"POST", 
        headers, 
        body: JSON.stringify({ topic }) 
      });

      const data = await resp.json();

      // Check if backend returned "explanation" key or raw array
      let content = data.explanation || data; 

      out.innerHTML = explainFormatter(content);

    } catch (err) {
      out.innerHTML = "<p style='color:#ff4d6d; text-align:center'>Error: " + esc(err.message||err) + "</p>";
    } finally {
      hide(loader); 
      btn.disabled = false;
    }
  });

})();
</script>
</body>
</html>